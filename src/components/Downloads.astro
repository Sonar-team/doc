---
// astro
import { Icon, LinkCard, CardGrid } from "@astrojs/starlight/components";

const OS_GROUPS = {
  Windows: [".exe", ".msi"],
  Linux: [".AppImage", ".deb", ".rpm"],
  macOS: [".dmg", ".app.tar.gz"],
};

let releaseInfo = null;
let data = [];

try {
  const response = await fetch("https://api.github.com/repos/Sonar-team/Sonar_desktop_app/releases/latest");
  if (!response.ok) throw new Error(`Erreur API: ${response.status} ${response.statusText}`);

  const jsonData = await response.json();
  releaseInfo = {
    name: jsonData.name,
    date: new Date(jsonData.published_at).toLocaleDateString(),
  };

  if (Array.isArray(jsonData.assets)) {
    data = jsonData.assets.filter(({ name }) =>
      Object.values(OS_GROUPS).flat().some((ext) => name.endsWith(ext))
    );
  }
} catch (err) {
  console.error("Erreur lors de la rÃ©cupÃ©ration des fichiers :", err);
}
---

<h2>ğŸ“¦ DerniÃ¨re version : {releaseInfo?.name} ({releaseInfo?.date})</h2>

{Object.entries(OS_GROUPS).map(([osName, extensions]) => {
  const osAssets = data.filter(({ name }) => extensions.some(ext => name.endsWith(ext)));
  return (
    <>
      <h3 style={{ marginTop: '2rem' }}>
        {osName === "Windows" ? "ğŸ–¥ï¸" : osName === "Linux" ? "ğŸ§" : "ğŸ"} {osName}
      </h3>
      <CardGrid>
        {osName === "Windows" && (
          <LinkCard
            title="ğŸ‘ï¸ Installateur DÃ©pendance Npcap 1.84"
            description="âš ï¸ Requis pour le fonctionnement du logiciel sur Windows"
            href="https://npcap.com/dist/npcap-1.84.exe"
          />
        )}
        {osAssets.length > 0 ? (
          osAssets.map((asset) => (
            <LinkCard
              title={`ğŸ“¥ ${asset.name}`}
              description={`ğŸ—“ï¸ ${new Date(asset.created_at).toLocaleDateString()} â€¢ ğŸ’¾ ${(asset.size / 1_000_000).toFixed(1)} MB â€¢ ğŸ”½ ${asset.download_count} tÃ©lÃ©chargements â€¢ ğŸ” SHA256: ${asset.digest}`}
              href={asset.browser_download_url}
            />

          ))
        ) : (
          <p>Aucun fichier disponible pour {osName}.</p>
        )}
      </CardGrid>
    </>
  );
})}
